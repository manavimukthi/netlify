<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Verifying Account - CEYLIZ</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="auth-page">
      <div class="auth-card">
        <h1>Verifying your account...</h1>
        <p>Please wait, we're getting things ready for you.</p>
      </div>
    </div>

    <script type="module">
      import { auth } from "./firebase-init.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

      onAuthStateChanged(auth, async (user) => {
        // Check if Firebase has automatically signed the user in and they are verified
        if (user && user.emailVerified) {
          console.log("User is verified!", user.uid);

          // Get the saved username and business type from browser storage
          const username = localStorage.getItem("usernameForN8n");
          const businessType = localStorage.getItem("businessTypeForN8n");

          // Trigger your n8n webhook with all the data
          const n8nWebhookUrl =
            "https://kimn8nceyliz.app.n8n.cloud/webhook/form";

          await fetch(n8nWebhookUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              uid: user.uid,
              email: user.email,
              username: username || null,
              businessType: businessType || null,
              isVerified: true, // You can add a flag to confirm verification
            }),
          });

          // Clean up the temporary storage
          localStorage.removeItem("usernameForN8n");
          localStorage.removeItem("businessTypeForN8n");

          // Send the user to their new dashboard
          window.location.href = "dashboard.html";
        } else {
          // If something went wrong or the user is not verified, they will stay on this page.
          console.log("User is not signed in or not verified yet.");
        }
      });
    </script>
  </body>
</html>
