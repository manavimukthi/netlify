<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ceyliz</title>
    <script>
      (function () {
        try {
          var stored = localStorage.getItem("theme");
          var prefersDark =
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches;
          var theme = stored || (prefersDark ? "dark" : "light");
          document.documentElement.setAttribute("data-theme", theme);
        } catch (e) {
          document.documentElement.setAttribute("data-theme", "light");
        }
      })();
    </script>
    <style>
      :root {
        --bg: #ffffff;
        --text: #0f172a;
        --muted: #f1f5f9;
        --border: #e2e8f0;
        --surface: #ffffff;
        --accent: #2563eb;
      }
      [data-theme="dark"] {
        --bg: #0b1220;
        --text: #e5edf5;
        --muted: #0f172a;
        --border: #1f2937;
        --surface: #101826;
        --accent: #7aa2ff;
      }

      body.dashboard-body {
        background-color: var(--bg);
        color: var(--text);
      }
      .topbar {
        background: var(--surface);
        border-bottom: 1px solid var(--border);
      }
      .top-link,
      .sidebar-link {
        color: var(--text);
      }
      .top-link.active {
        color: var(--accent);
      }
      .dashboard-sidebar {
        background: var(--surface);
        border-right: 1px solid var(--border);
      }
      .dashboard-content {
        background: var(--bg);
      }
      .dash-title {
        color: var(--text);
      }

      .tool-block {
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border);
      }
      .tool-block.add-tool {
        color: var(--accent);
      }

      /* Ensure strong visibility for tool cards in dark mode */
      [data-theme="dark"] .tool-block {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.02)
        );
        color: var(--text);
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 18px 50px rgba(0, 0, 0, 0.55);
      }
      [data-theme="dark"] .tool-block.add-tool {
        background: linear-gradient(
          180deg,
          rgba(122, 162, 255, 0.08),
          rgba(122, 162, 255, 0.04)
        );
        border-color: rgba(122, 162, 255, 0.25);
        color: var(--accent);
      }

      .account-popup {
        background: var(--surface);
        border: 1px solid var(--border);
        color: var(--text);
      }
      .page-loader {
        background: var(--bg);
      }
      .logo-link .logo-img {
        filter: var(--logo-filter, none);
      }
      [data-theme="dark"] .logo-link .logo-img {
        filter: brightness(1.1) contrast(1.1);
      }
    </style>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="CEYLIZ favicon icon.svg" type="image/svg+xml" />
  </head>
  <body class="dashboard-body">
    <div
      id="pageLoader"
      class="page-loader"
      aria-live="polite"
      aria-label="Loading"
    >
      <div class="loader-inner">
        <object
          data="CEYLIZ Logo icon.svg"
          type="image/svg+xml"
          class="loader-logo"
          aria-label="CEYLIZ animated logo"
        >
          CEYLIZ
        </object>
      </div>
    </div>
    <header class="topbar">
      <div class="topbar-inner">
        <div class="topbar-left">
          <a href="home.html" class="logo-link" aria-label="Home">
            <img src="CEYLIZ favicon icon.svg" alt="Logo" class="logo-img" />
          </a>
          <nav class="top-menu">
            <a href="dashboard.html" class="top-link active">Dashboard</a>
            <a href="#" class="top-link">Learn</a>
          </nav>
        </div>
        <div class="topbar-right">
          <button class="icon-btn" aria-label="Notifications">ðŸ””</button>
          <button class="icon-btn" id="themeToggle" aria-label="Toggle theme">
            ðŸŒ—
          </button>
          <div class="avatar small"></div>
          <button class="account-btn" id="accountBtn">Account â–¾</button>
          <div
            class="account-popup"
            id="accountPopup"
            aria-hidden="true"
            role="menu"
            aria-label="Account menu"
          >
            <div class="acct-user" aria-live="polite">
              <div class="acct-name" id="acctName"></div>
              <div class="acct-email" id="acctEmail"></div>
              <div class="acct-plan" id="acctPlan"></div>
            </div>
            <div class="acct-sep"></div>
            <div class="acct-item" id="acctView" role="menuitem">
              View Account
            </div>
            <div class="acct-item" id="acctSettings" role="menuitem">
              Settings
            </div>
            <div class="acct-sep"></div>
            <div class="acct-item" id="acctLogout" role="menuitem">Log out</div>
            <div class="acct-item" id="acctProfile" role="menuitem">
              Profile
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="dashboard">
      <aside class="dashboard-sidebar">
        <div class="workspace">
          <span class="ws-icon">âœ¦</span>
          <span class="workspace-name"></span>
        </div>
        <ul class="sidebar-list">
          <li><a class="sidebar-link active" href="#">All sites</a></li>
          <li><a class="sidebar-link" href="#">Tutorials</a></li>
        </ul>
        <div class="sidebar-heading">Settings</div>
        <ul class="sidebar-list">
          <li><a class="sidebar-link" href="#">General</a></li>
          <li><a class="sidebar-link" href="#">Team</a></li>
          <li><a class="sidebar-link" href="#">Plans</a></li>
          <li><a class="sidebar-link" href="#">Billing</a></li>
          <li><a class="sidebar-link" href="#">Apps & Integrations â–¸</a></li>
          <li><a class="sidebar-link" href="#">Libraries & Templates â–¸</a></li>
        </ul>
      </aside>

      <section class="dashboard-content">
        <div class="dash-section active" id="tools-home">
          <h2 class="dash-title">YOUR TOOLS</h2>
          <div class="tools-grid">
            <button class="tool-block">TOOL 1</button>
            <button class="tool-block">TOOL 2</button>
            <button class="tool-block">TOOL 3</button>
            <button class="tool-block">TOOL 4</button>
          </div>
          <div class="tools-grid">
            <button class="tool-block add-tool" id="addTool">
              <span class="plus">+</span>
              <span>ADD TOOL</span>
            </button>
          </div>
        </div>
      </section>
    </main>

    <script src="main.js"></script>
    <script>
      (function () {
        var btn = document.getElementById("themeToggle");
        function setTheme(theme) {
          document.documentElement.setAttribute("data-theme", theme);
          try {
            localStorage.setItem("theme", theme);
          } catch (e) {}
          if (btn) {
            btn.setAttribute(
              "aria-pressed",
              theme === "dark" ? "true" : "false"
            );
            btn.textContent = theme === "dark" ? "ðŸŒž" : "ðŸŒ—";
            btn.title =
              theme === "dark" ? "Switch to light mode" : "Switch to dark mode";
          }
        }
        var current =
          document.documentElement.getAttribute("data-theme") || "light";
        setTheme(current);
        if (btn) {
          btn.addEventListener("click", function () {
            var next =
              document.documentElement.getAttribute("data-theme") === "dark"
                ? "light"
                : "dark";
            setTheme(next);
          });
        }
      })();
    </script>
    <script type="module">
      import { auth, db } from "./firebase-init.js";
      import {
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
      import {
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

      // Get references to UI
      const accountBtn = document.getElementById("accountBtn");
      const accountPopup = document.getElementById("accountPopup");
      const nameEl = document.getElementById("acctName");
      const emailEl = document.getElementById("acctEmail");
      const planEl = document.getElementById("acctPlan");
      const avatarEl = document.querySelector(".avatar.small");
      const workspaceNameEl = document.querySelector(".workspace-name");

      // Popup helpers
      function openPopup() {
        if (!accountPopup) return;
        accountPopup.classList.add("visible");
        accountPopup.setAttribute("aria-hidden", "false");
        document.addEventListener("click", onDocClick, true);
        document.addEventListener("keydown", onKeyDown, true);
      }
      function closePopup() {
        if (!accountPopup) return;
        accountPopup.classList.remove("visible");
        accountPopup.setAttribute("aria-hidden", "true");
        document.removeEventListener("click", onDocClick, true);
        document.removeEventListener("keydown", onKeyDown, true);
      }
      function togglePopup() {
        if (!accountPopup) return;
        const isOpen = accountPopup.classList.contains("visible");
        isOpen ? closePopup() : openPopup();
      }
      function onDocClick(e) {
        if (!accountPopup.contains(e.target) && e.target !== accountBtn) {
          closePopup();
        }
      }
      function onKeyDown(e) {
        if (e.key === "Escape") closePopup();
      }
      if (accountBtn) {
        accountBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          togglePopup();
        });
      }

      // Auth state listener -> populate UI from Firestore or fallback to localStorage
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          // No logged-in user -> redirect to login
          localStorage.removeItem("currentUser");
          window.location.href = "login.html";
          return;
        }

        // Try Firestore first
        try {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists()) {
            const data = userDoc.data();
            const profile = {
              uid: user.uid,
              name: data.name || user.displayName || "",
              email: data.email || user.email || "",
              plan: data.plan || "FREE",
              businessType: data.businessType || "",
            };
            // persist locally
            try {
              localStorage.setItem("currentUser", JSON.stringify(profile));
            } catch (e) {
              console.warn(e);
            }
            populateUI(profile);
            return;
          }
        } catch (e) {
          console.warn("Error reading profile from Firestore", e);
        }

        // Fallback to localStorage
        try {
          const stored = localStorage.getItem("currentUser");
          if (stored) {
            const profile = JSON.parse(stored);
            populateUI(profile);
            return;
          }
        } catch (e) {
          console.warn("Failed to parse currentUser from localStorage", e);
        }

        // Final fallback: basic info from auth
        const basic = {
          uid: user.uid,
          name: user.displayName || "",
          email: user.email || "",
          plan: "FREE",
        };
        populateUI(basic);
      });

      function populateUI(user) {
        if (nameEl) nameEl.textContent = user.name || "";
        if (emailEl) emailEl.textContent = user.email || "";
        if (planEl) planEl.textContent = (user.plan || "FREE").toUpperCase();
        if (workspaceNameEl) {
          const firstName = (user.name || "").split(" ")[0] || "My";
          workspaceNameEl.textContent = `${firstName}'s Workspace`;
        }
        if (avatarEl) {
          const initials = (user.name || "")
            .split(" ")
            .filter(Boolean)
            .map((n) => n[0])
            .join("")
            .slice(0, 2)
            .toUpperCase();
          avatarEl.textContent = initials || "U";
        }
      }

      // Logout wiring using Firebase
      const acctLogout = document.getElementById("acctLogout");
      if (acctLogout) {
        acctLogout.addEventListener("click", async (e) => {
          e.stopPropagation();
          try {
            await signOut(auth);
          } catch (err) {
            console.warn("Sign out failed", err);
          }
          try {
            localStorage.removeItem("currentUser");
          } catch (e) {}
          closePopup();
          window.location.href = "login.html";
        });
      }

      // Other small popup actions
      const acctProfile = document.getElementById("acctProfile");
      const acctView = document.getElementById("acctView");
      const acctSettings = document.getElementById("acctSettings");
      if (acctProfile)
        acctProfile.addEventListener("click", () => closePopup());
      if (acctView) acctView.addEventListener("click", () => closePopup());
      if (acctSettings)
        acctSettings.addEventListener("click", () => closePopup());
    </script>
  </body>
</html>
